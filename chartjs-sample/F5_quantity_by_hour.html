<!DOCTYPE html>
<html>
<head>
    <title>Hwaseung Vina Factory 5 Quantity by Hour Chart</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.js"></script>
    <script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
    <style>
        body {
            font-family: Helvetica Neue, Arial, sans-serif;
            text-align: center;
        }
    </style>
</head>
<body>
<canvas id="myChart"></canvas>
<script>
    updateChart();

    setInterval(function () {
        updateChart();
    }, 60000);

    function updateChart() {
        $(document).ready(function () {
            var obj = new Object();
            obj.SiteID = '6257c91aeca6b8efd08a3cc8bd027c59';
            obj.ObjectName = ['Fac5_Qty_By_Hour'];
            $.ajax({
                type: 'POST',
                url: 'http://smart.hsvina.com/proxy/Metric/Get',
                data: '{"SiteID": "6257c91aeca6b8efd08a3cc8bd027c59", "ObjectName": [ "Fac5_Qty_By_Hour" ]}',
                success: function (data) {
                    // Our labels along the x-axis
                    var time = [
                        "8:30", "9:30", "10:30", "11:30", "12:30", "13:30", "14:30",
                        "15:30", "16:30", "17:30", "18:30", "19:30", "20:30"
                    ];

                    // For drawing the line
                    var chartData = [];
                    data.Result.Fac5_Qty_By_Hour.value.metric_1.map((value, index) => {
                        var item = {x: time[index], y: value};
                        chartData.push(item);
                    });
                    // Remove trailing 0 (zero) data
                    for (var i = chartData.length - 1; i >= 0; --i) {
                        if (chartData[i].y === 0) {
                            chartData.pop();
                        } else {
                            break;
                        }
                    }

                    var minMaxTicksYAxesConfig = computeMinMaxTickOnYAxes(false, chartData.map(item => +item.y));

                    buildNewLineChart(chartData, minMaxTicksYAxesConfig);
                },
                contentType: "application/json",
                dataType: 'json',
            });
        });
    }

    function buildNewLineChart(data, minMaxTicksYAxesConfig) {
        // Our labels along the x-axis
        var labels = data.map(item => moment(item.x, 'H:mm'));

        // For drawing the line
        var chartData = data.map(item => +item.y);

        let ctx = document.getElementById('myChart');
        let myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'quantity',
                    data: chartData,
                    pointRadius: 0.5,
                    borderColor: '#ed4940',
                    backgroundColor: '#ed494040',
                    pointBorderColor: '#ed4940',
                    pointBackgroundColor: '#ed4940',
                    tension: 0,
                }]
            },
            options: {
                responsive: true,
                legend: {
                    display: false,
                },
                scales: {
                    xAxes: [{
                        type: 'time',
                        ticks: {
                            maxRotation: 90,
                            minRotation: 0,
                            fontColor: '#fff',
                            padding: 5,
                        },
                        time: {
                            tooltipFormat: 'H:mm',
                            unit: 'minute',
                            stepSize: 60,
                            displayFormats: {
                                'minute': 'H:mm',
                            },
                        },
                        gridLines: {
                            display: false,
                        },
                    }],
                    yAxes: [{
                        ticks: {
                            fontColor: '#fff',
                            min: minMaxTicksYAxesConfig.min,
                            max: minMaxTicksYAxesConfig.max,
                            padding: 10,
                        },
                        gridLines: {
                            drawBorder: false,
                        },
                    }],
                },
            },
        });
    }

    // Example: MAX_VALUE_IN_GRAPH -> MAX_TICK_ON_Y_AXES:
    // (1...9) -> (1...9) + 1
    // (10...99) -> (10...99) + 10
    // (100...999) -> (100...999) + 100
    // (1000...9999) -> (1000...9999) + 1000
    // (10000...99999) -> (10000...99999) + 1000
    // (100000...999999) -> (100000...999999) + 100000
    function computeMinMaxTickOnYAxes(isComputeMinTick, ...arrays) {
        var min = Number.MAX_SAFE_INTEGER, max = 0;
        arrays.map(array => array.map(value => {
            if (value < min) {
                min = value;
            }
            if (value > max) {
                max = value;
            }
        }));
        var numOfDigits = max.toString().length;

        // TODO: Calculate Step Size by Max_Y_Tick_Odd or Max_Y_Tick_Even number
        var factor = 2;
        for (var i = 1; i < numOfDigits; ++i) {
            factor *= 10;
        }
        var maxTickOnYAxes = factor + Math.floor(max / factor) * factor;    // 258,679 -> 200,000 + 100,000

        // TODO: Calculate Step Size by Max_Y_Tick_Odd or Max_Y_Tick_Even number

        if (isComputeMinTick) {
            return {
                min: min,
                max: maxTickOnYAxes,
            };
        }
        return {
            min: 0,
            max: maxTickOnYAxes,
        };
    }
</script>
</body>
</html>
